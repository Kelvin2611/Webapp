<script>
  document.getElementById("generate-pdf").addEventListener("click", async function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Get form values
    const site = document.getElementById("site").value;
    const client = document.getElementById("client").value === "Other" ? document.getElementById("other-client").value : document.getElementById("client").value;
    const clientPO = document.getElementById("client-po").value;
    const jobType = document.getElementById("job-type").value;
    const dateStarted = document.getElementById("date-started").value;
    const riskAssessment = document.getElementById("risk-assessment").value;
    const worksCarriedOut = document.getElementById("works-carried-out").value;
    const jobStatus = document.getElementById("job-status").value;
    const completedOn = document.getElementById("completed-on").value;

    // Add form data to PDF
    let y = 10; // Initial y position
    doc.text(`Site: ${site}`, 10, y); y += 10;
    doc.text(`Client: ${client}`, 10, y); y += 10;
    doc.text(`Client PO: ${clientPO}`, 10, y); y += 10;
    doc.text(`Job Type: ${jobType}`, 10, y); y += 10;
    doc.text(`Date Started: ${dateStarted}`, 10, y); y += 10;
    doc.text(`Risk Assessment: ${riskAssessment}`, 10, y); y += 10;
    doc.text("Works Carried Out:", 10, y); y += 10;
    doc.text(worksCarriedOut, 10, y); y += 20; // Allow space for multiline text
    doc.text(`Job Status: ${jobStatus}`, 10, y); y += 10;
    doc.text(`Completed On: ${completedOn}`, 10, y); y += 10;

    // Add signatures
    const clientCanvas = document.getElementById("client-signature");
    const engineerCanvas = document.getElementById("engineer-signature");
    const clientSignature = clientCanvas.toDataURL("image/png");
    const engineerSignature = engineerCanvas.toDataURL("image/png");

    doc.addImage(clientSignature, "PNG", 10, y, 90, 30); y += 40;
    doc.text("Client Signature", 10, y); y += 10;

    doc.addImage(engineerSignature, "PNG", 10, y, 90, 30); y += 40;
    doc.text("Engineer Signature", 10, y); y += 10;

    // Add photographs (up to 5)
    const photos = document.getElementById("photos").files;
    for (let i = 0; i < photos.length && i < 5; i++) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const imgData = event.target.result;
        doc.addImage(imgData, "JPEG", 10, y, 90, 60);
        y += 70;
        if (i === photos.length - 1 || i === 4) {
          saveAndSendPDF(doc, site, dateStarted);
        }
      };
      reader.readAsDataURL(photos[i]);
    }

    // If no photos are added, save and send PDF directly
    if (photos.length === 0) {
      saveAndSendPDF(doc, site, dateStarted);
    }
  });

  function saveAndSendPDF(doc, site, dateStarted) {
    const filename = `${site}-${dateStarted}.pdf`;
    const pdfBlob = doc.output("blob");

    // Create FormData to send the PDF to the backend
    const formData = new FormData();
    formData.append("pdf", pdfBlob, filename);
    formData.append("site", site);
    formData.append("date", dateStarted);

    // Save the PDF locally and send it to the backend
    doc.save(filename);

    // Send the PDF to the backend for emailing
    fetch("http://localhost:3000/send-email", {
      method: "POST",
      body: formData,
    })
      .then((response) => {
        if (response.ok) {
          alert("PDF generated and emailed successfully!");
        } else {
          alert("Failed to send the email. Please try again.");
        }
      })
      .catch((error) => {
        console.error("Error sending email:", error);
        alert("Error sending email. Check the console for details.");
      });
  }
</script>
